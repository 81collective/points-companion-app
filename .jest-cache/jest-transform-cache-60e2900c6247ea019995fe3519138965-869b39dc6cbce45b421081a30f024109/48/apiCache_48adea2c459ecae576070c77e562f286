5a9bd11e0280ab1ab9e6191129223e21
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getCacheMetrics = exports.warmupCache = exports.apiCache = exports.advancedApiCache = void 0;
class AdvancedAPICache {
    constructor(config) {
        this.cache = new Map();
        this.pendingRequests = new Map();
        this.stats = {
            hits: 0,
            misses: 0,
            evictions: 0,
            sets: 0,
            deletes: 0,
            size: 0,
            itemCount: 0
        };
        this.config = {
            maxSize: 50 * 1024 * 1024, // 50MB default
            defaultTTL: 5 * 60 * 1000, // 5 minutes
            enablePersistence: true,
            persistenceKey: 'api-cache-persistence',
            enableCompression: false,
            lruEnabled: true
        };
        if (config) {
            this.config = Object.assign(Object.assign({}, this.config), config);
        }
        // Load persisted cache on initialization
        if (this.config.enablePersistence && typeof window !== 'undefined') {
            this.loadPersistedCache();
        }
        // Set up periodic cleanup and persistence
        if (typeof global !== 'undefined') {
            setInterval(() => {
                this.cleanup();
                if (this.config.enablePersistence) {
                    this.persistCache();
                }
            }, 60000); // Every minute
        }
    }
    // Generate cache key from request parameters with advanced hashing
    generateKey(params, prefix = 'api') {
        const sortedParams = Object.keys(params)
            .sort()
            .reduce((result, key) => {
            result[key] = params[key];
            return result;
        }, {});
        const paramString = JSON.stringify(sortedParams);
        return `${prefix}:${this.simpleHash(paramString)}`;
    }
    // Simple hash function for cache keys
    simpleHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convert to 32-bit integer
        }
        return Math.abs(hash).toString(36);
    }
    // Estimate size of data in bytes
    estimateSize(data) {
        const str = JSON.stringify(data);
        return str ? str.length * 2 : 0; // Rough estimate: 2 bytes per character
    }
    // Get cached data with LRU tracking
    get(key) {
        const entry = this.cache.get(key);
        if (!entry) {
            this.stats.misses++;
            return null;
        }
        const now = Date.now();
        if (now - entry.timestamp > entry.ttl) {
            this.cache.delete(key);
            this.stats.size -= entry.size;
            this.stats.itemCount--;
            this.stats.misses++;
            return null;
        }
        // Update LRU tracking
        entry.accessCount++;
        entry.lastAccessed = now;
        this.stats.hits++;
        return entry.data;
    }
    // Set cache entry with advanced features
    set(key, data, options = {}) {
        const ttl = options.ttl || this.config.defaultTTL;
        const size = this.estimateSize(data);
        const now = Date.now();
        // Check if we need to evict entries to make room
        if (this.stats.size + size > this.config.maxSize) {
            this.evictLRU(size);
        }
        const entry = {
            data,
            timestamp: now,
            ttl,
            accessCount: 0,
            lastAccessed: now,
            size,
            tags: options.tags
        };
        // Remove old entry if it exists
        const oldEntry = this.cache.get(key);
        if (oldEntry) {
            this.stats.size -= oldEntry.size;
            this.stats.itemCount--;
        }
        this.cache.set(key, entry);
        this.stats.size += size;
        this.stats.itemCount++;
        this.stats.sets++;
    }
    // LRU eviction
    evictLRU(requiredSpace) {
        if (!this.config.lruEnabled)
            return;
        const entries = Array.from(this.cache.entries())
            .sort(([, a], [, b]) => {
            // Sort by access count, then by last accessed time
            if (a.accessCount !== b.accessCount) {
                return a.accessCount - b.accessCount;
            }
            return a.lastAccessed - b.lastAccessed;
        });
        let freedSpace = 0;
        for (const [key, entry] of entries) {
            if (freedSpace >= requiredSpace)
                break;
            this.cache.delete(key);
            this.stats.size -= entry.size;
            this.stats.itemCount--;
            this.stats.evictions++;
            freedSpace += entry.size;
        }
    }
    // Delete cache entry
    delete(key) {
        const entry = this.cache.get(key);
        if (entry) {
            this.cache.delete(key);
            this.stats.size -= entry.size;
            this.stats.itemCount--;
            this.stats.deletes++;
            return true;
        }
        return false;
    }
    // Clear cache by tags
    clearByTags(tags) {
        let cleared = 0;
        for (const [key, entry] of this.cache.entries()) {
            if (entry.tags && entry.tags.some(tag => tags.includes(tag))) {
                this.cache.delete(key);
                this.stats.size -= entry.size;
                this.stats.itemCount--;
                this.stats.deletes++;
                cleared++;
            }
        }
        return cleared;
    }
    // Clear all cache
    clear() {
        this.cache.clear();
        this.stats.size = 0;
        this.stats.itemCount = 0;
        this.stats.deletes += this.stats.itemCount;
    }
    // Handle request deduplication with enhanced error handling
    async dedupe(key, requestFn, options = {}) {
        // Check cache first if enabled
        if (options.useCache !== false) {
            const cached = this.get(key);
            if (cached !== null) {
                return cached;
            }
        }
        // Check if request is already pending
        const pending = this.pendingRequests.get(key);
        if (pending) {
            return pending;
        }
        // Execute request and cache the promise
        const promise = requestFn()
            .then(result => {
            // Cache successful results
            if (options.useCache !== false) {
                this.set(key, result, {
                    ttl: options.ttl,
                    tags: options.tags
                });
            }
            return result;
        })
            .finally(() => {
            this.pendingRequests.delete(key);
        });
        this.pendingRequests.set(key, promise);
        return promise;
    }
    // Get cache statistics
    getStats() {
        return Object.assign({}, this.stats);
    }
    // Get cache hit rate
    getHitRate() {
        const total = this.stats.hits + this.stats.misses;
        return total > 0 ? this.stats.hits / total : 0;
    }
    // Cleanup expired entries
    cleanup() {
        const now = Date.now();
        for (const [key, entry] of this.cache.entries()) {
            if (now - entry.timestamp > entry.ttl) {
                this.cache.delete(key);
                this.stats.size -= entry.size;
                this.stats.itemCount--;
            }
        }
    }
    // Persist cache to localStorage
    persistCache() {
        if (typeof window === 'undefined' || !window.localStorage)
            return;
        try {
            const persistableData = Array.from(this.cache.entries())
                .filter(([, entry]) => {
                // Only persist entries that haven't expired and aren't too large
                const now = Date.now();
                return (now - entry.timestamp < entry.ttl) && entry.size < 1024 * 1024; // < 1MB
            })
                .map(([key, entry]) => [key, {
                    data: entry.data,
                    timestamp: entry.timestamp,
                    ttl: entry.ttl,
                    accessCount: entry.accessCount,
                    lastAccessed: entry.lastAccessed,
                    size: entry.size,
                    tags: entry.tags
                }]);
            localStorage.setItem(this.config.persistenceKey, JSON.stringify({
                data: persistableData,
                timestamp: Date.now()
            }));
        }
        catch (error) {
            console.warn('Failed to persist cache:', error);
        }
    }
    // Load persisted cache from localStorage
    loadPersistedCache() {
        if (typeof window === 'undefined' || !window.localStorage)
            return;
        try {
            const persisted = localStorage.getItem(this.config.persistenceKey);
            if (!persisted)
                return;
            const { data, timestamp } = JSON.parse(persisted);
            const now = Date.now();
            // Only load if persisted within last 24 hours
            if (now - timestamp > 24 * 60 * 60 * 1000) {
                localStorage.removeItem(this.config.persistenceKey);
                return;
            }
            for (const [key, entry] of data) {
                // Check if entry is still valid
                if (now - entry.timestamp < entry.ttl) {
                    this.cache.set(key, entry);
                    this.stats.size += entry.size;
                    this.stats.itemCount++;
                }
            }
            console.log(`Loaded ${this.stats.itemCount} persisted cache entries`);
        }
        catch (error) {
            console.warn('Failed to load persisted cache:', error);
            localStorage.removeItem(this.config.persistenceKey);
        }
    }
    // Warm up cache with frequently accessed data
    async warmup(keys) {
        const warmupPromises = keys.map(async (key) => {
            // This would typically fetch from a fast source or pre-computed data
            // For now, just ensure the key exists in cache
            return this.cache.has(key);
        });
        await Promise.all(warmupPromises);
    }
}
// Global advanced cache instance with optimized settings
exports.advancedApiCache = new AdvancedAPICache({
    maxSize: 100 * 1024 * 1024, // 100MB for better performance
    defaultTTL: 10 * 60 * 1000, // 10 minutes for better cache hit rates
    enablePersistence: true,
    persistenceKey: 'points-companion-cache-v2',
    enableCompression: false, // Can be enabled later with compression library
    lruEnabled: true
});
// Legacy cache instance for backward compatibility
exports.apiCache = exports.advancedApiCache;
// Cache warming utility
const warmupCache = async (frequentlyUsedKeys) => {
    await exports.advancedApiCache.warmup(frequentlyUsedKeys);
};
exports.warmupCache = warmupCache;
// Cache monitoring utility
const getCacheMetrics = () => {
    const stats = exports.advancedApiCache.getStats();
    const hitRate = exports.advancedApiCache.getHitRate();
    return Object.assign(Object.assign({}, stats), { hitRate: `${(hitRate * 100).toFixed(2)}%`, sizeFormatted: `${(stats.size / 1024 / 1024).toFixed(2)}MB`, efficiency: hitRate > 0.8 ? 'Excellent' : hitRate > 0.6 ? 'Good' : 'Needs Optimization' });
};
exports.getCacheMetrics = getCacheMetrics;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxNZWRpYSBTZXJ2ZXJcXERvY3VtZW50c1xcUHJvamVjdHNcXHBvaW50cy1jb21wYW5pb24tYXBwXFxzcmNcXGxpYlxcYXBpQ2FjaGUudHMiLCJtYXBwaW5ncyI6Ijs7O0FBOEJBLE1BQU0sZ0JBQWdCO0lBc0JwQixZQUFZLE1BQTZCO1FBckJqQyxVQUFLLEdBQUcsSUFBSSxHQUFHLEVBQXNCLENBQUM7UUFDdEMsb0JBQWUsR0FBRyxJQUFJLEdBQUcsRUFBNEIsQ0FBQztRQUN0RCxVQUFLLEdBQWU7WUFDMUIsSUFBSSxFQUFFLENBQUM7WUFDUCxNQUFNLEVBQUUsQ0FBQztZQUNULFNBQVMsRUFBRSxDQUFDO1lBQ1osSUFBSSxFQUFFLENBQUM7WUFDUCxPQUFPLEVBQUUsQ0FBQztZQUNWLElBQUksRUFBRSxDQUFDO1lBQ1AsU0FBUyxFQUFFLENBQUM7U0FDYixDQUFDO1FBRU0sV0FBTSxHQUFnQjtZQUM1QixPQUFPLEVBQUUsRUFBRSxHQUFHLElBQUksR0FBRyxJQUFJLEVBQUUsZUFBZTtZQUMxQyxVQUFVLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLEVBQUUsWUFBWTtZQUN2QyxpQkFBaUIsRUFBRSxJQUFJO1lBQ3ZCLGNBQWMsRUFBRSx1QkFBdUI7WUFDdkMsaUJBQWlCLEVBQUUsS0FBSztZQUN4QixVQUFVLEVBQUUsSUFBSTtTQUNqQixDQUFDO1FBR0EsSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUNYLElBQUksQ0FBQyxNQUFNLG1DQUFRLElBQUksQ0FBQyxNQUFNLEdBQUssTUFBTSxDQUFFLENBQUM7UUFDOUMsQ0FBQztRQUVELHlDQUF5QztRQUN6QyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsaUJBQWlCLElBQUksT0FBTyxNQUFNLEtBQUssV0FBVyxFQUFFLENBQUM7WUFDbkUsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFDNUIsQ0FBQztRQUVELDBDQUEwQztRQUMxQyxJQUFJLE9BQU8sTUFBTSxLQUFLLFdBQVcsRUFBRSxDQUFDO1lBQ2xDLFdB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QUMxRSxVQUFVLEVBQUUsSUFBSTtDQUNqQixDQUFDLENBQUM7QUFFSCxtREFBbUQ7QUFDdEMsUUFBQSxRQUFRLEdBQUcsd0JBQWdCLENBQUM7QUFFekMsd0JBQXdCO0FBQ2pCLE1BQU0sV0FBVyxHQUFHLEtBQUssRUFBRSxrQkFBNEIsRUFBRSxFQUFFO0lBQ2hFLE1BQU0sd0JBQWdCLENBQUMsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFDcEQsQ0FBQyxDQUFDO0FBRlcsUUFBQSxXQUFXLGVBRXRCO0FBRUYsMkJBQTJCO0FBQ3BCLE1BQU0sZUFBZSxHQUFHLEdBQUcsRUFBRTtJQUNsQyxNQUFNLEtBQUssR0FBRyx3QkFBZ0IsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUMxQyxNQUFNLE9BQU8sR0FBRyx3QkFBZ0IsQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUU5Qyx1Q0FDSyxLQUFLLEtBQ1IsT0FBTyxFQUFFLEdBQUcsQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQ3pDLGFBQWEsRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQzNELFVBQVUsRUFBRSxPQUFPLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsb0JBQW9CLElBQ3ZGO0FBQ0osQ0FBQyxDQUFDO0FBVlcsUUFBQSxlQUFlLG1CQVUxQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXE1lZGlhIFNlcnZlclxcRG9jdW1lbnRzXFxQcm9qZWN0c1xccG9pbnRzLWNvbXBhbmlvbi1hcHBcXHNyY1xcbGliXFxhcGlDYWNoZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBBZHZhbmNlZCBSZWRpcy1saWtlIGluLW1lbW9yeSBjYWNoZSB3aXRoIExSVSBldmljdGlvbiwgcGVyc2lzdGVuY2UsIGFuZCBhZHZhbmNlZCBmZWF0dXJlc1xyXG5pbnRlcmZhY2UgQ2FjaGVFbnRyeTxUID0gdW5rbm93bj4ge1xyXG4gIGRhdGE6IFQ7XHJcbiAgdGltZXN0YW1wOiBudW1iZXI7XHJcbiAgdHRsOiBudW1iZXI7XHJcbiAgYWNjZXNzQ291bnQ6IG51bWJlcjtcclxuICBsYXN0QWNjZXNzZWQ6IG51bWJlcjtcclxuICBzaXplOiBudW1iZXI7IC8vIEVzdGltYXRlZCBzaXplIGluIGJ5dGVzXHJcbiAgdGFncz86IHN0cmluZ1tdOyAvLyBGb3IgY2FjaGUgaW52YWxpZGF0aW9uIGJ5IHRhZ3NcclxufVxyXG5cclxuaW50ZXJmYWNlIENhY2hlU3RhdHMge1xyXG4gIGhpdHM6IG51bWJlcjtcclxuICBtaXNzZXM6IG51bWJlcjtcclxuICBldmljdGlvbnM6IG51bWJlcjtcclxuICBzZXRzOiBudW1iZXI7XHJcbiAgZGVsZXRlczogbnVtYmVyO1xyXG4gIHNpemU6IG51bWJlcjsgLy8gVG90YWwgY2FjaGUgc2l6ZSBpbiBieXRlc1xyXG4gIGl0ZW1Db3VudDogbnVtYmVyO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgQ2FjaGVDb25maWcge1xyXG4gIG1heFNpemU6IG51bWJlcjsgLy8gTWF4aW11bSBjYWNoZSBzaXplIGluIGJ5dGVzXHJcbiAgZGVmYXVsdFRUTDogbnVtYmVyOyAvLyBEZWZhdWx0IFRUTCBpbiBtaWxsaXNlY29uZHNcclxuICBlbmFibGVQZXJzaXN0ZW5jZTogYm9vbGVhbjtcclxuICBwZXJzaXN0ZW5jZUtleTogc3RyaW5nO1xyXG4gIGVuYWJsZUNvbXByZXNzaW9uOiBib29sZWFuO1xyXG4gIGxydUVuYWJsZWQ6IGJvb2xlYW47XHJcbn1cclxuXHJcbmNsYXNzIEFkdmFuY2VkQVBJQ2FjaGUge1xyXG4gIHByaXZhdGUgY2FjaGUgPSBuZXcgTWFwPHN0cmluZywgQ2FjaGVFbnRyeT4oKTtcclxuICBwcml2YXRlIHBlbmRpbmdSZXF1ZXN0cyA9IG5ldyBNYXA8c3RyaW5nLCBQcm9taXNlPHVua25vd24+PigpO1xyXG4gIHByaXZhdGUgc3RhdHM6IENhY2hlU3RhdHMgPSB7XHJcbiAgICBoaXRzOiAwLFxyXG4gICAgbWlzc2VzOiAwLFxyXG4gICAgZXZpY3Rpb25zOiAwLFxyXG4gICAgc2V0czogMCxcclxuICAgIGRlbGV0ZXM6IDAsXHJcbiAgICBzaXplOiAwLFxyXG4gICAgaXRlbUNvdW50OiAwXHJcbiAgfTtcclxuXHJcbiAgcHJpdmF0ZSBjb25maWc6IENhY2hlQ29uZmlnID0ge1xyXG4gICAgbWF4U2l6ZTogNTAgKiAxMDI0ICogMTAyNCwgLy8gNTBNQiBkZWZhdWx0XHJcbiAgICBkZWZhdWx0VFRMOiA1ICogNjAgKiAxMDAwLCAvLyA1IG1pbnV0ZXNcclxuICAgIGVuYWJsZVBlcnNpc3RlbmNlOiB0cnVlLFxyXG4gICAgcGVyc2lzdGVuY2VLZXk6ICdhcGktY2FjaGUtcGVyc2lzdGVuY2UnLFxyXG4gICAgZW5hYmxlQ29tcHJlc3Npb246IGZhbHNlLFxyXG4gICAgbHJ1RW5hYmxlZDogdHJ1ZVxyXG4gIH07XHJcblxyXG4gIGNvbnN0cnVjdG9yKGNvbmZpZz86IFBhcnRpYWw8Q2FjaGVDb25maWc+KSB7XHJcbiAgICBpZiAoY29uZmlnKSB7XHJcbiAgICAgIHRoaXMuY29uZmlnID0geyAuLi50aGlzLmNvbmZpZywgLi4uY29uZmlnIH07XHJcbiAgICB9XHJcblxyXG4gICAgLy8gTG9hZCBwZXJzaXN0ZWQgY2FjaGUgb24gaW5pdGlhbGl6YXRpb25cclxuICAgIGlmICh0aGlzLmNvbmZpZy5lbmFibGVQZXJzaXN0ZW5jZSAmJiB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykge1xyXG4gICAgICB0aGlzLmxvYWRQZXJzaXN0ZWRDYWNoZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFNldCB1cCBwZXJpb2RpYyBjbGVhbnVwIGFuZCBwZXJzaXN0ZW5jZVxyXG4gICAgaWYgKHR5cGVvZiBnbG9iYWwgIT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgIHNldEludGVydmFsKCgpID0+IHtcclxuICAgICAgICB0aGlzLmNsZWFudXAoKTtcclxuICAgICAgICBpZiAodGhpcy5jb25maWcuZW5hYmxlUGVyc2lzdGVuY2UpIHtcclxuICAgICAgICAgIHRoaXMucGVyc2lzdENhY2hlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9LCA2MDAwMCk7IC8vIEV2ZXJ5IG1pbnV0ZVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gR2VuZXJhdGUgY2FjaGUga2V5IGZyb20gcmVxdWVzdCBwYXJhbWV0ZXJzIHdpdGggYWR2YW5jZWQgaGFzaGluZ1xyXG4gIGdlbmVyYXRlS2V5KHBhcmFtczogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sIHByZWZpeCA9ICdhcGknKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IHNvcnRlZFBhcmFtcyA9IE9iamVjdC5rZXlzKHBhcmFtcylcclxuICAgICAgLnNvcnQoKVxyXG4gICAgICAucmVkdWNlKChyZXN1bHQsIGtleSkgPT4ge1xyXG4gICAgICAgIHJlc3VsdFtrZXldID0gcGFyYW1zW2tleV07XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgfSwge30gYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pO1xyXG5cclxuICAgIGNvbnN0IHBhcmFtU3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoc29ydGVkUGFyYW1zKTtcclxuICAgIHJldHVybiBgJHtwcmVmaXh9OiR7dGhpcy5zaW1wbGVIYXNoKHBhcmFtU3RyaW5nKX1gO1xyXG4gIH1cclxuXHJcbiAgLy8gU2ltcGxlIGhhc2ggZnVuY3Rpb24gZm9yIGNhY2hlIGtleXNcclxuICBwcml2YXRlIHNpbXBsZUhhc2goc3RyOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgbGV0IGhhc2ggPSAwO1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyBpKyspIHtcclxuICAgICAgY29uc3QgY2hhciA9IHN0ci5jaGFyQ29kZUF0KGkpO1xyXG4gICAgICBoYXNoID0gKChoYXNoIDw8IDUpIC0gaGFzaCkgKyBjaGFyO1xyXG4gICAgICBoYXNoID0gaGFzaCAmIGhhc2g7IC8vIENvbnZlcnQgdG8gMzItYml0IGludGVnZXJcclxuICAgIH1cclxuICAgIHJldHVybiBNYXRoLmFicyhoYXNoKS50b1N0cmluZygzNik7XHJcbiAgfVxyXG5cclxuICAvLyBFc3RpbWF0ZSBzaXplIG9mIGRhdGEgaW4gYnl0ZXNcclxuICBwcml2YXRlIGVzdGltYXRlU2l6ZShkYXRhOiB1bmtub3duKTogbnVtYmVyIHtcclxuICAgIGNvbnN0IHN0ciA9IEpTT04uc3RyaW5naWZ5KGRhdGEpO1xyXG4gICAgcmV0dXJuIHN0ciA/IHN0ci5sZW5ndGggKiAyIDogMDsgLy8gUm91Z2ggZXN0aW1hdGU6IDIgYnl0ZXMgcGVyIGNoYXJhY3RlclxyXG4gIH1cclxuXHJcbiAgLy8gR2V0IGNhY2hlZCBkYXRhIHdpdGggTFJVIHRyYWNraW5nXHJcbiAgZ2V0PFQgPSB1bmtub3duPihrZXk6IHN0cmluZyk6IFQgfCBudWxsIHtcclxuICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5jYWNoZS5nZXQoa2V5KTtcclxuICAgIGlmICghZW50cnkpIHtcclxuICAgICAgdGhpcy5zdGF0cy5taXNzZXMrKztcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcclxuICAgIGlmIChub3cgLSBlbnRyeS50aW1lc3RhbXAgPiBlbnRyeS50dGwpIHtcclxuICAgICAgdGhpcy5jYWNoZS5kZWxldGUoa2V5KTtcclxuICAgICAgdGhpcy5zdGF0cy5zaXplIC09IGVudHJ5LnNpemU7XHJcbiAgICAgIHRoaXMuc3RhdHMuaXRlbUNvdW50LS07XHJcbiAgICAgIHRoaXMuc3RhdHMubWlzc2VzKys7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFVwZGF0ZSBMUlUgdHJhY2tpbmdcclxuICAgIGVudHJ5LmFjY2Vzc0NvdW50Kys7XHJcbiAgICBlbnRyeS5sYXN0QWNjZXNzZWQgPSBub3c7XHJcbiAgICB0aGlzLnN0YXRzLmhpdHMrKztcclxuXHJcbiAgICByZXR1cm4gZW50cnkuZGF0YSBhcyBUO1xyXG4gIH1cclxuXHJcbiAgLy8gU2V0IGNhY2hlIGVudHJ5IHdpdGggYWR2YW5jZWQgZmVhdHVyZXNcclxuICBzZXQ8VCA9IHVua25vd24+KFxyXG4gICAga2V5OiBzdHJpbmcsXHJcbiAgICBkYXRhOiBULFxyXG4gICAgb3B0aW9uczoge1xyXG4gICAgICB0dGw/OiBudW1iZXI7XHJcbiAgICAgIHRhZ3M/OiBzdHJpbmdbXTtcclxuICAgICAgY29tcHJlc3M/OiBib29sZWFuO1xyXG4gICAgfSA9IHt9XHJcbiAgKTogdm9pZCB7XHJcbiAgICBjb25zdCB0dGwgPSBvcHRpb25zLnR0bCB8fCB0aGlzLmNvbmZpZy5kZWZhdWx0VFRMO1xyXG4gICAgY29uc3Qgc2l6ZSA9IHRoaXMuZXN0aW1hdGVTaXplKGRhdGEpO1xyXG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcclxuXHJcbiAgICAvLyBDaGVjayBpZiB3ZSBuZWVkIHRvIGV2aWN0IGVudHJpZXMgdG8gbWFrZSByb29tXHJcbiAgICBpZiAodGhpcy5zdGF0cy5zaXplICsgc2l6ZSA+IHRoaXMuY29uZmlnLm1heFNpemUpIHtcclxuICAgICAgdGhpcy5ldmljdExSVShzaXplKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBlbnRyeTogQ2FjaGVFbnRyeTxUPiA9IHtcclxuICAgICAgZGF0YSxcclxuICAgICAgdGltZXN0YW1wOiBub3csXHJcbiAgICAgIHR0bCxcclxuICAgICAgYWNjZXNzQ291bnQ6IDAsXHJcbiAgICAgIGxhc3RBY2Nlc3NlZDogbm93LFxyXG4gICAgICBzaXplLFxyXG4gICAgICB0YWdzOiBvcHRpb25zLnRhZ3NcclxuICAgIH07XHJcblxyXG4gICAgLy8gUmVtb3ZlIG9sZCBlbnRyeSBpZiBpdCBleGlzdHNcclxuICAgIGNvbnN0IG9sZEVudHJ5ID0gdGhpcy5jYWNoZS5nZXQoa2V5KTtcclxuICAgIGlmIChvbGRFbnRyeSkge1xyXG4gICAgICB0aGlzLnN0YXRzLnNpemUgLT0gb2xkRW50cnkuc2l6ZTtcclxuICAgICAgdGhpcy5zdGF0cy5pdGVtQ291bnQtLTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmNhY2hlLnNldChrZXksIGVudHJ5KTtcclxuICAgIHRoaXMuc3RhdHMuc2l6ZSArPSBzaXplO1xyXG4gICAgdGhpcy5zdGF0cy5pdGVtQ291bnQrKztcclxuICAgIHRoaXMuc3RhdHMuc2V0cysrO1xyXG4gIH1cclxuXHJcbiAgLy8gTFJVIGV2aWN0aW9uXHJcbiAgcHJpdmF0ZSBldmljdExSVShyZXF1aXJlZFNwYWNlOiBudW1iZXIpOiB2b2lkIHtcclxuICAgIGlmICghdGhpcy5jb25maWcubHJ1RW5hYmxlZCkgcmV0dXJuO1xyXG5cclxuICAgIGNvbnN0IGVudHJpZXMgPSBBcnJheS5mcm9tKHRoaXMuY2FjaGUuZW50cmllcygpKVxyXG4gICAgICAuc29ydCgoWywgYV0sIFssIGJdKSA9PiB7XHJcbiAgICAgICAgLy8gU29ydCBieSBhY2Nlc3MgY291bnQsIHRoZW4gYnkgbGFzdCBhY2Nlc3NlZCB0aW1lXHJcbiAgICAgICAgaWYgKGEuYWNjZXNzQ291bnQgIT09IGIuYWNjZXNzQ291bnQpIHtcclxuICAgICAgICAgIHJldHVybiBhLmFjY2Vzc0NvdW50IC0gYi5hY2Nlc3NDb3VudDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGEubGFzdEFjY2Vzc2VkIC0gYi5sYXN0QWNjZXNzZWQ7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgIGxldCBmcmVlZFNwYWNlID0gMDtcclxuICAgIGZvciAoY29uc3QgW2tleSwgZW50cnldIG9mIGVudHJpZXMpIHtcclxuICAgICAgaWYgKGZyZWVkU3BhY2UgPj0gcmVxdWlyZWRTcGFjZSkgYnJlYWs7XHJcblxyXG4gICAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpO1xyXG4gICAgICB0aGlzLnN0YXRzLnNpemUgLT0gZW50cnkuc2l6ZTtcclxuICAgICAgdGhpcy5zdGF0cy5pdGVtQ291bnQtLTtcclxuICAgICAgdGhpcy5zdGF0cy5ldmljdGlvbnMrKztcclxuICAgICAgZnJlZWRTcGFjZSArPSBlbnRyeS5zaXplO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gRGVsZXRlIGNhY2hlIGVudHJ5XHJcbiAgZGVsZXRlKGtleTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCBlbnRyeSA9IHRoaXMuY2FjaGUuZ2V0KGtleSk7XHJcbiAgICBpZiAoZW50cnkpIHtcclxuICAgICAgdGhpcy5jYWNoZS5kZWxldGUoa2V5KTtcclxuICAgICAgdGhpcy5zdGF0cy5zaXplIC09IGVudHJ5LnNpemU7XHJcbiAgICAgIHRoaXMuc3RhdHMuaXRlbUNvdW50LS07XHJcbiAgICAgIHRoaXMuc3RhdHMuZGVsZXRlcysrO1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIC8vIENsZWFyIGNhY2hlIGJ5IHRhZ3NcclxuICBjbGVhckJ5VGFncyh0YWdzOiBzdHJpbmdbXSk6IG51bWJlciB7XHJcbiAgICBsZXQgY2xlYXJlZCA9IDA7XHJcbiAgICBmb3IgKGNvbnN0IFtrZXksIGVudHJ5XSBvZiB0aGlzLmNhY2hlLmVudHJpZXMoKSkge1xyXG4gICAgICBpZiAoZW50cnkudGFncyAmJiBlbnRyeS50YWdzLnNvbWUodGFnID0+IHRhZ3MuaW5jbHVkZXModGFnKSkpIHtcclxuICAgICAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpO1xyXG4gICAgICAgIHRoaXMuc3RhdHMuc2l6ZSAtPSBlbnRyeS5zaXplO1xyXG4gICAgICAgIHRoaXMuc3RhdHMuaXRlbUNvdW50LS07XHJcbiAgICAgICAgdGhpcy5zdGF0cy5kZWxldGVzKys7XHJcbiAgICAgICAgY2xlYXJlZCsrO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gY2xlYXJlZDtcclxuICB9XHJcblxyXG4gIC8vIENsZWFyIGFsbCBjYWNoZVxyXG4gIGNsZWFyKCk6IHZvaWQge1xyXG4gICAgdGhpcy5jYWNoZS5jbGVhcigpO1xyXG4gICAgdGhpcy5zdGF0cy5zaXplID0gMDtcclxuICAgIHRoaXMuc3RhdHMuaXRlbUNvdW50ID0gMDtcclxuICAgIHRoaXMuc3RhdHMuZGVsZXRlcyArPSB0aGlzLnN0YXRzLml0ZW1Db3VudDtcclxuICB9XHJcblxyXG4gIC8vIEhhbmRsZSByZXF1ZXN0IGRlZHVwbGljYXRpb24gd2l0aCBlbmhhbmNlZCBlcnJvciBoYW5kbGluZ1xyXG4gIGFzeW5jIGRlZHVwZTxUPihcclxuICAgIGtleTogc3RyaW5nLFxyXG4gICAgcmVxdWVzdEZuOiAoKSA9PiBQcm9taXNlPFQ+LFxyXG4gICAgb3B0aW9uczoge1xyXG4gICAgICB0dGw/OiBudW1iZXI7XHJcbiAgICAgIHRhZ3M/OiBzdHJpbmdbXTtcclxuICAgICAgdXNlQ2FjaGU/OiBib29sZWFuO1xyXG4gICAgfSA9IHt9XHJcbiAgKTogUHJvbWlzZTxUPiB7XHJcbiAgICAvLyBDaGVjayBjYWNoZSBmaXJzdCBpZiBlbmFibGVkXHJcbiAgICBpZiAob3B0aW9ucy51c2VDYWNoZSAhPT0gZmFsc2UpIHtcclxuICAgICAgY29uc3QgY2FjaGVkID0gdGhpcy5nZXQ8VD4oa2V5KTtcclxuICAgICAgaWYgKGNhY2hlZCAhPT0gbnVsbCkge1xyXG4gICAgICAgIHJldHVybiBjYWNoZWQ7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBDaGVjayBpZiByZXF1ZXN0IGlzIGFscmVhZHkgcGVuZGluZ1xyXG4gICAgY29uc3QgcGVuZGluZyA9IHRoaXMucGVuZGluZ1JlcXVlc3RzLmdldChrZXkpO1xyXG4gICAgaWYgKHBlbmRpbmcpIHtcclxuICAgICAgcmV0dXJuIHBlbmRpbmcgYXMgUHJvbWlzZTxUPjtcclxuICAgIH1cclxuXHJcbiAgICAvLyBFeGVjdXRlIHJlcXVlc3QgYW5kIGNhY2hlIHRoZSBwcm9taXNlXHJcbiAgICBjb25zdCBwcm9taXNlID0gcmVxdWVzdEZuKClcclxuICAgICAgLnRoZW4ocmVzdWx0ID0+IHtcclxuICAgICAgICAvLyBDYWNoZSBzdWNjZXNzZnVsIHJlc3VsdHNcclxuICAgICAgICBpZiAob3B0aW9ucy51c2VDYWNoZSAhPT0gZmFsc2UpIHtcclxuICAgICAgICAgIHRoaXMuc2V0KGtleSwgcmVzdWx0LCB7XHJcbiAgICAgICAgICAgIHR0bDogb3B0aW9ucy50dGwsXHJcbiAgICAgICAgICAgIHRhZ3M6IG9wdGlvbnMudGFnc1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgIH0pXHJcbiAgICAgIC5maW5hbGx5KCgpID0+IHtcclxuICAgICAgICB0aGlzLnBlbmRpbmdSZXF1ZXN0cy5kZWxldGUoa2V5KTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgdGhpcy5wZW5kaW5nUmVxdWVzdHMuc2V0KGtleSwgcHJvbWlzZSk7XHJcbiAgICByZXR1cm4gcHJvbWlzZTtcclxuICB9XHJcblxyXG4gIC8vIEdldCBjYWNoZSBzdGF0aXN0aWNzXHJcbiAgZ2V0U3RhdHMoKTogQ2FjaGVTdGF0cyB7XHJcbiAgICByZXR1cm4geyAuLi50aGlzLnN0YXRzIH07XHJcbiAgfVxyXG5cclxuICAvLyBHZXQgY2FjaGUgaGl0IHJhdGVcclxuICBnZXRIaXRSYXRlKCk6IG51bWJlciB7XHJcbiAgICBjb25zdCB0b3RhbCA9IHRoaXMuc3RhdHMuaGl0cyArIHRoaXMuc3RhdHMubWlzc2VzO1xyXG4gICAgcmV0dXJuIHRvdGFsID4gMCA/IHRoaXMuc3RhdHMuaGl0cyAvIHRvdGFsIDogMDtcclxuICB9XHJcblxyXG4gIC8vIENsZWFudXAgZXhwaXJlZCBlbnRyaWVzXHJcbiAgY2xlYW51cCgpOiB2b2lkIHtcclxuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XHJcbiAgICBmb3IgKGNvbnN0IFtrZXksIGVudHJ5XSBvZiB0aGlzLmNhY2hlLmVudHJpZXMoKSkge1xyXG4gICAgICBpZiAobm93IC0gZW50cnkudGltZXN0YW1wID4gZW50cnkudHRsKSB7XHJcbiAgICAgICAgdGhpcy5jYWNoZS5kZWxldGUoa2V5KTtcclxuICAgICAgICB0aGlzLnN0YXRzLnNpemUgLT0gZW50cnkuc2l6ZTtcclxuICAgICAgICB0aGlzLnN0YXRzLml0ZW1Db3VudC0tO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBQZXJzaXN0IGNhY2hlIHRvIGxvY2FsU3RvcmFnZVxyXG4gIHByaXZhdGUgcGVyc2lzdENhY2hlKCk6IHZvaWQge1xyXG4gICAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICd1bmRlZmluZWQnIHx8ICF3aW5kb3cubG9jYWxTdG9yYWdlKSByZXR1cm47XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgcGVyc2lzdGFibGVEYXRhID0gQXJyYXkuZnJvbSh0aGlzLmNhY2hlLmVudHJpZXMoKSlcclxuICAgICAgICAuZmlsdGVyKChbLCBlbnRyeV0pID0+IHtcclxuICAgICAgICAgIC8vIE9ubHkgcGVyc2lzdCBlbnRyaWVzIHRoYXQgaGF2ZW4ndCBleHBpcmVkIGFuZCBhcmVuJ3QgdG9vIGxhcmdlXHJcbiAgICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgICAgcmV0dXJuIChub3cgLSBlbnRyeS50aW1lc3RhbXAgPCBlbnRyeS50dGwpICYmIGVudHJ5LnNpemUgPCAxMDI0ICogMTAyNDsgLy8gPCAxTUJcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5tYXAoKFtrZXksIGVudHJ5XSkgPT4gW2tleSwge1xyXG4gICAgICAgICAgZGF0YTogZW50cnkuZGF0YSxcclxuICAgICAgICAgIHRpbWVzdGFtcDogZW50cnkudGltZXN0YW1wLFxyXG4gICAgICAgICAgdHRsOiBlbnRyeS50dGwsXHJcbiAgICAgICAgICBhY2Nlc3NDb3VudDogZW50cnkuYWNjZXNzQ291bnQsXHJcbiAgICAgICAgICBsYXN0QWNjZXNzZWQ6IGVudHJ5Lmxhc3RBY2Nlc3NlZCxcclxuICAgICAgICAgIHNpemU6IGVudHJ5LnNpemUsXHJcbiAgICAgICAgICB0YWdzOiBlbnRyeS50YWdzXHJcbiAgICAgICAgfV0pO1xyXG5cclxuICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5jb25maWcucGVyc2lzdGVuY2VLZXksIEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgICBkYXRhOiBwZXJzaXN0YWJsZURhdGEsXHJcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpXHJcbiAgICAgIH0pKTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUud2FybignRmFpbGVkIHRvIHBlcnNpc3QgY2FjaGU6JywgZXJyb3IpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gTG9hZCBwZXJzaXN0ZWQgY2FjaGUgZnJvbSBsb2NhbFN0b3JhZ2VcclxuICBwcml2YXRlIGxvYWRQZXJzaXN0ZWRDYWNoZSgpOiB2b2lkIHtcclxuICAgIGlmICh0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJyB8fCAhd2luZG93LmxvY2FsU3RvcmFnZSkgcmV0dXJuO1xyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHBlcnNpc3RlZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMuY29uZmlnLnBlcnNpc3RlbmNlS2V5KTtcclxuICAgICAgaWYgKCFwZXJzaXN0ZWQpIHJldHVybjtcclxuXHJcbiAgICAgIGNvbnN0IHsgZGF0YSwgdGltZXN0YW1wIH0gPSBKU09OLnBhcnNlKHBlcnNpc3RlZCk7XHJcbiAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XHJcblxyXG4gICAgICAvLyBPbmx5IGxvYWQgaWYgcGVyc2lzdGVkIHdpdGhpbiBsYXN0IDI0IGhvdXJzXHJcbiAgICAgIGlmIChub3cgLSB0aW1lc3RhbXAgPiAyNCAqIDYwICogNjAgKiAxMDAwKSB7XHJcbiAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0odGhpcy5jb25maWcucGVyc2lzdGVuY2VLZXkpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgZm9yIChjb25zdCBba2V5LCBlbnRyeV0gb2YgZGF0YSkge1xyXG4gICAgICAgIC8vIENoZWNrIGlmIGVudHJ5IGlzIHN0aWxsIHZhbGlkXHJcbiAgICAgICAgaWYgKG5vdyAtIGVudHJ5LnRpbWVzdGFtcCA8IGVudHJ5LnR0bCkge1xyXG4gICAgICAgICAgdGhpcy5jYWNoZS5zZXQoa2V5LCBlbnRyeSk7XHJcbiAgICAgICAgICB0aGlzLnN0YXRzLnNpemUgKz0gZW50cnkuc2l6ZTtcclxuICAgICAgICAgIHRoaXMuc3RhdHMuaXRlbUNvdW50Kys7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zb2xlLmxvZyhgTG9hZGVkICR7dGhpcy5zdGF0cy5pdGVtQ291bnR9IHBlcnNpc3RlZCBjYWNoZSBlbnRyaWVzYCk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLndhcm4oJ0ZhaWxlZCB0byBsb2FkIHBlcnNpc3RlZCBjYWNoZTonLCBlcnJvcik7XHJcbiAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKHRoaXMuY29uZmlnLnBlcnNpc3RlbmNlS2V5KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIFdhcm0gdXAgY2FjaGUgd2l0aCBmcmVxdWVudGx5IGFjY2Vzc2VkIGRhdGFcclxuICBhc3luYyB3YXJtdXAoa2V5czogc3RyaW5nW10pOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGNvbnN0IHdhcm11cFByb21pc2VzID0ga2V5cy5tYXAoYXN5bmMgKGtleSkgPT4ge1xyXG4gICAgICAvLyBUaGlzIHdvdWxkIHR5cGljYWxseSBmZXRjaCBmcm9tIGEgZmFzdCBzb3VyY2Ugb3IgcHJlLWNvbXB1dGVkIGRhdGFcclxuICAgICAgLy8gRm9yIG5vdywganVzdCBlbnN1cmUgdGhlIGtleSBleGlzdHMgaW4gY2FjaGVcclxuICAgICAgcmV0dXJuIHRoaXMuY2FjaGUuaGFzKGtleSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBhd2FpdCBQcm9taXNlLmFsbCh3YXJtdXBQcm9taXNlcyk7XHJcbiAgfVxyXG59XHJcblxyXG4vLyBHbG9iYWwgYWR2YW5jZWQgY2FjaGUgaW5zdGFuY2Ugd2l0aCBvcHRpbWl6ZWQgc2V0dGluZ3NcclxuZXhwb3J0IGNvbnN0IGFkdmFuY2VkQXBpQ2FjaGUgPSBuZXcgQWR2YW5jZWRBUElDYWNoZSh7XHJcbiAgbWF4U2l6ZTogMTAwICogMTAyNCAqIDEwMjQsIC8vIDEwME1CIGZvciBiZXR0ZXIgcGVyZm9ybWFuY2VcclxuICBkZWZhdWx0VFRMOiAxMCAqIDYwICogMTAwMCwgLy8gMTAgbWludXRlcyBmb3IgYmV0dGVyIGNhY2hlIGhpdCByYXRlc1xyXG4gIGVuYWJsZVBlcnNpc3RlbmNlOiB0cnVlLFxyXG4gIHBlcnNpc3RlbmNlS2V5OiAncG9pbnRzLWNvbXBhbmlvbi1jYWNoZS12MicsXHJcbiAgZW5hYmxlQ29tcHJlc3Npb246IGZhbHNlLCAvLyBDYW4gYmUgZW5hYmxlZCBsYXRlciB3aXRoIGNvbXByZXNzaW9uIGxpYnJhcnlcclxuICBscnVFbmFibGVkOiB0cnVlXHJcbn0pO1xyXG5cclxuLy8gTGVnYWN5IGNhY2hlIGluc3RhbmNlIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5XHJcbmV4cG9ydCBjb25zdCBhcGlDYWNoZSA9IGFkdmFuY2VkQXBpQ2FjaGU7XHJcblxyXG4vLyBDYWNoZSB3YXJtaW5nIHV0aWxpdHlcclxuZXhwb3J0IGNvbnN0IHdhcm11cENhY2hlID0gYXN5bmMgKGZyZXF1ZW50bHlVc2VkS2V5czogc3RyaW5nW10pID0+IHtcclxuICBhd2FpdCBhZHZhbmNlZEFwaUNhY2hlLndhcm11cChmcmVxdWVudGx5VXNlZEtleXMpO1xyXG59O1xyXG5cclxuLy8gQ2FjaGUgbW9uaXRvcmluZyB1dGlsaXR5XHJcbmV4cG9ydCBjb25zdCBnZXRDYWNoZU1ldHJpY3MgPSAoKSA9PiB7XHJcbiAgY29uc3Qgc3RhdHMgPSBhZHZhbmNlZEFwaUNhY2hlLmdldFN0YXRzKCk7XHJcbiAgY29uc3QgaGl0UmF0ZSA9IGFkdmFuY2VkQXBpQ2FjaGUuZ2V0SGl0UmF0ZSgpO1xyXG5cclxuICByZXR1cm4ge1xyXG4gICAgLi4uc3RhdHMsXHJcbiAgICBoaXRSYXRlOiBgJHsoaGl0UmF0ZSAqIDEwMCkudG9GaXhlZCgyKX0lYCxcclxuICAgIHNpemVGb3JtYXR0ZWQ6IGAkeyhzdGF0cy5zaXplIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUJgLFxyXG4gICAgZWZmaWNpZW5jeTogaGl0UmF0ZSA+IDAuOCA/ICdFeGNlbGxlbnQnIDogaGl0UmF0ZSA+IDAuNiA/ICdHb29kJyA6ICdOZWVkcyBPcHRpbWl6YXRpb24nXHJcbiAgfTtcclxufTtcclxuIl0sInZlcnNpb24iOjN9