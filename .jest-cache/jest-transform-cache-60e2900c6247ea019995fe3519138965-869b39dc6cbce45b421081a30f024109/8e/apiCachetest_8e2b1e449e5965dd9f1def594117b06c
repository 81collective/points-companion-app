40739692e66525e5ecfdcd287374b76d
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const apiCache_1 = require("../../lib/apiCache");
// Mock localStorage
const localStorageMock = {
    getItem: jest.fn(),
    setItem: jest.fn(),
    removeItem: jest.fn(),
    clear: jest.fn(),
};
Object.defineProperty(window, 'localStorage', {
    value: localStorageMock,
});
describe('apiCache', () => {
    beforeEach(() => {
        jest.clearAllMocks();
        // Reset cache state
        apiCache_1.advancedApiCache.clear();
    });
    describe('Basic Cache Operations', () => {
        it('should store and retrieve data correctly', async () => {
            const testData = { message: 'Hello World' };
            const cacheKey = 'test-key';
            await apiCache_1.advancedApiCache.set(cacheKey, testData);
            const retrieved = await apiCache_1.advancedApiCache.get(cacheKey);
            expect(retrieved).toEqual(testData);
        });
        it('should return null for non-existent keys', async () => {
            const retrieved = await apiCache_1.advancedApiCache.get('non-existent-key');
            expect(retrieved).toBeNull();
        });
        it('should handle cache expiration', async () => {
            const testData = { message: 'Expires quickly' };
            const cacheKey = 'expiring-key';
            // Set with very short TTL (1ms)
            await apiCache_1.advancedApiCache.set(cacheKey, testData, { ttl: 1 });
            // Wait for expiration
            await new Promise(resolve => setTimeout(resolve, 2));
            const retrieved = await apiCache_1.advancedApiCache.get(cacheKey);
            expect(retrieved).toBeNull();
        });
        it('should clear all cache entries', async () => {
            await apiCache_1.advancedApiCache.set('key1', 'value1');
            await apiCache_1.advancedApiCache.set('key2', 'value2');
            apiCache_1.advancedApiCache.clear();
            expect(await apiCache_1.advancedApiCache.get('key1')).toBeNull();
            expect(await apiCache_1.advancedApiCache.get('key2')).toBeNull();
        });
    });
    describe('LRU Eviction', () => {
        it('should evict least recently used items when capacity is exceeded', async () => {
            // Set a small capacity for testing
            const originalCapacity = apiCache_1.advancedApiCache.capacity;
            apiCache_1.advancedApiCache.capacity = 3;
            await apiCache_1.advancedApiCache.set('key1', 'value1');
            await apiCache_1.advancedApiCache.set('key2', 'value2');
            await apiCache_1.advancedApiCache.set('key3', 'value3');
            await apiCache_1.advancedApiCache.set('key4', 'value4'); // This should evict key1
            expect(await apiCache_1.advancedApiCache.get('key1')).toBeNull();
            expect(await apiCache_1.advancedApiCache.get('key2')).toEqual('value2');
            expect(await apiCache_1.advancedApiCache.get('key3')).toEqual('value3');
            expect(await apiCache_1.advancedApiCache.get('key4')).toEqual('value4');
            // Restore original capacity
            apiCache_1.advancedApiCache.capacity = originalCapacity;
        });
        it('should update LRU order on access', async () => {
            const originalCapacity = apiCache_1.advancedApiCache.capacity;
            apiCache_1.advancedApiCache.capacity = 3;
            await apiCache_1.advancedApiCache.set('key1', 'value1');
            await apiCache_1.advancedApiCache.set('key2', 'value2');
            await apiCache_1.advancedApiCache.set('key3', 'value3');
            // Access key1 to make it most recently used
            await apiCache_1.advancedApiCache.get('key1');
            // Add key4, should evict key2 (least recently used)
            await apiCache_1.advancedApiCache.set('key4', 'value4');
            expect(await apiCache_1.advancedApiCache.get('key1')).toEqual('value1'); // Still there
            expect(await apiCache_1.advancedApiCache.get('key2')).toBeNull(); // Evicted
            expect(await apiCache_1.advancedApiCache.get('key3')).toEqual('value3');
            expect(await apiCache_1.advancedApiCache.get('key4')).toEqual('value4');
            apiCache_1.advancedApiCache.capacity = originalCapacity;
        });
    });
    describe('Cache Persistence', () => {
        it('should persist cache to localStorage', async () => {
            const testData = { persistent: true };
            await apiCache_1.advancedApiCache.set('persistent-key', testData);
            // Check that localStorage.setItem was called
            expect(localStorageMock.setItem).toHaveBeenCalled();
            const callArgs = localStorageMock.setItem.mock.calls.find(call => call[0] === 'api-cache-data');
            expect(callArgs).toBeTruthy();
        });
        it('should load cache from localStorage on initialization', () => {
            const mockCacheData = {
                'loaded-key': {
                    data: 'loaded-value',
                    timestamp: Date.now(),
                    ttl: 3600000,
                },
            };
            localStorageMock.getItem.mockReturnValue(JSON.stringify(mockCacheData));
            // Create new cache instance to test loading
            const newCache = require('../../lib/apiCache').apiCache;
            // The cache should have loaded the data
            expect(localStorageMock.getItem).toHaveBeenCalledWith('api-cache-data');
        });
    });
    describe('Cache Statistics', () => {
        it('should track cache hits and misses', async () => {
            await apiCache_1.advancedApiCache.set('stats-key', 'stats-value');
            // Hit
            await apiCache_1.advancedApiCache.get('stats-key');
            // Miss
            await apiCache_1.advancedApiCache.get('non-existent-key');
            const stats = apiCache_1.advancedApiCache.getStats();
            expect(stats.hits).toBe(1);
            expect(stats.misses).toBe(1);
            expect(apiCache_1.advancedApiCache.getHitRate()).toBe(0.5);
        });
        it('should track cache size and capacity', async () => {
            await apiCache_1.advancedApiCache.set('size-key1', 'value1');
            await apiCache_1.advancedApiCache.set('size-key2', 'value2');
            const stats = apiCache_1.advancedApiCache.getStats();
            expect(stats.size).toBeGreaterThan(0);
            expect(stats.itemCount).toBe(2);
        });
    });
    describe('Request Deduplication', () => {
        it('should deduplicate concurrent requests for the same key', async () => {
            let callCount = 0;
            const mockFetcher = jest.fn(() => {
                callCount++;
                return Promise.resolve('fetched-data');
            });
            // Simulate concurrent requests
            const promises = [
                apiCache_1.advancedApiCache.dedupe('dedupe-key', mockFetcher),
                apiCache_1.advancedApiCache.dedupe('dedupe-key', mockFetcher),
                apiCache_1.advancedApiCache.dedupe('dedupe-key', mockFetcher),
            ];
            const results = await Promise.all(promises);
            // All should return the same data
            results.forEach((result) => {
                expect(result).toBe('fetched-data');
            });
            // But fetcher should only be called once
            expect(callCount).toBe(1);
        });
        it('should handle fetch errors gracefully', async () => {
            const mockFetcher = jest.fn(() => Promise.reject(new Error('Fetch failed')));
            await expect(apiCache_1.advancedApiCache.dedupe('error-key', mockFetcher)).rejects.toThrow('Fetch failed');
            // Should not cache the error
            expect(await apiCache_1.advancedApiCache.get('error-key')).toBeNull();
        });
    });
    describe('Tag-based Invalidation', () => {
        it('should invalidate entries by tag', async () => {
            await apiCache_1.advancedApiCache.set('tagged-key1', 'value1', { tags: ['tag1'] });
            await apiCache_1.advancedApiCache.set('tagged-key2', 'value2', { tags: ['tag1', 'tag2'] });
            await apiCache_1.advancedApiCache.set('untagged-key', 'value3');
            apiCache_1.advancedApiCache.clearByTags(['tag1']);
            expect(await apiCache_1.advancedApiCache.get('tagged-key1')).toBeNull();
            expect(await apiCache_1.advancedApiCache.get('tagged-key2')).toBeNull();
            expect(await apiCache_1.advancedApiCache.get('untagged-key')).toEqual('value3');
        });
        it('should handle multiple tags correctly', async () => {
            await apiCache_1.advancedApiCache.set('multi-key', 'value', { tags: ['tag1', 'tag2', 'tag3'] });
            apiCache_1.advancedApiCache.clearByTags(['tag2']);
            expect(await apiCache_1.advancedApiCache.get('multi-key')).toBeNull();
        });
    });
    describe('Performance and Memory Management', () => {
        it('should handle large datasets efficiently', async () => {
            const largeData = Array.from({ length: 1000 }, (_, i) => ({
                id: i,
                data: 'x'.repeat(1000), // 1KB per item
            }));
            const startTime = performance.now();
            for (let i = 0; i < largeData.length; i++) {
                await apiCache_1.advancedApiCache.set(`large-key-${i}`, largeData[i]);
            }
            const endTime = performance.now();
            const duration = endTime - startTime;
            // Should complete within reasonable time (adjust threshold as needed)
            expect(duration).toBeLessThan(5000); // 5 seconds max
            // Should be able to retrieve items
            const retrieved = await apiCache_1.advancedApiCache.get('large-key-500');
            expect(retrieved).toEqual(largeData[500]);
        });
        it('should maintain performance under concurrent load', async () => {
            const concurrentOperations = 100;
            const promises = [];
            for (let i = 0; i < concurrentOperations; i++) {
                promises.push(apiCache_1.advancedApiCache.set(`concurrent-key-${i}`, `value-${i}`));
            }
            const startTime = performance.now();
            await Promise.all(promises);
            const endTime = performance.now();
            expect(endTime - startTime).toBeLessThan(2000); // 2 seconds max
            // Verify all operations completed
            for (let i = 0; i < concurrentOperations; i++) {
                const value = await apiCache_1.advancedApiCache.get(`concurrent-key-${i}`);
                expect(value).toBe(`value-${i}`);
            }
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxNZWRpYSBTZXJ2ZXJcXERvY3VtZW50c1xcUHJvamVjdHNcXHBvaW50cy1jb21wYW5pb24tYXBwXFxzcmNcXHRlc3RcXGxpYlxcYXBpQ2FjaGUudGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLGlEQUFrRTtBQUVsRSxvQkFBb0I7QUFDcEIsTUFBTSxnQkFBZ0IsR0FBRztJQUN2QixPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUNsQixPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUNsQixVQUFVLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUNyQixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtDQUNqQixDQUFDO0FBRUYsTUFBTSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEVBQUUsY0FBYyxFQUFFO0lBQzVDLEtBQUssRUFBRSxnQkFBZ0I7Q0FDeEIsQ0FBQyxDQUFDO0FBRUgsUUFBUSxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUU7SUFDeEIsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNyQixvQkFBb0I7UUFDcEIsMkJBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNuQixDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyx3QkFBd0IsRUFBRSxHQUFHLEVBQUU7UUFDdEMsRUFBRSxDQUFDLDBDQUEwQyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3hELE1BQU0sUUFBUSxHQUFHLEVBQUUsT0FBTyxFQUFFLGFBQWEsRUFBRSxDQUFDO1lBQzVDLE1BQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQztZQUU1QixNQUFNLDJCQUFRLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUN2QyxNQUFNLFNBQVMsR0FBRyxNQUFNLDJCQUFRLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRS9DLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFD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QyxNQUFNLEtBQUssR0FBRyxNQUFNLDJCQUFRLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUN4RCxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNuQyxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcTWVkaWEgU2VydmVyXFxEb2N1bWVudHNcXFByb2plY3RzXFxwb2ludHMtY29tcGFuaW9uLWFwcFxcc3JjXFx0ZXN0XFxsaWJcXGFwaUNhY2hlLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYWR2YW5jZWRBcGlDYWNoZSBhcyBhcGlDYWNoZSB9IGZyb20gJy4uLy4uL2xpYi9hcGlDYWNoZSc7XHJcblxyXG4vLyBNb2NrIGxvY2FsU3RvcmFnZVxyXG5jb25zdCBsb2NhbFN0b3JhZ2VNb2NrID0ge1xyXG4gIGdldEl0ZW06IGplc3QuZm4oKSxcclxuICBzZXRJdGVtOiBqZXN0LmZuKCksXHJcbiAgcmVtb3ZlSXRlbTogamVzdC5mbigpLFxyXG4gIGNsZWFyOiBqZXN0LmZuKCksXHJcbn07XHJcblxyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkod2luZG93LCAnbG9jYWxTdG9yYWdlJywge1xyXG4gIHZhbHVlOiBsb2NhbFN0b3JhZ2VNb2NrLFxyXG59KTtcclxuXHJcbmRlc2NyaWJlKCdhcGlDYWNoZScsICgpID0+IHtcclxuICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xyXG4gICAgLy8gUmVzZXQgY2FjaGUgc3RhdGVcclxuICAgIGFwaUNhY2hlLmNsZWFyKCk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdCYXNpYyBDYWNoZSBPcGVyYXRpb25zJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBzdG9yZSBhbmQgcmV0cmlldmUgZGF0YSBjb3JyZWN0bHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHRlc3REYXRhID0geyBtZXNzYWdlOiAnSGVsbG8gV29ybGQnIH07XHJcbiAgICAgIGNvbnN0IGNhY2hlS2V5ID0gJ3Rlc3Qta2V5JztcclxuXHJcbiAgICAgIGF3YWl0IGFwaUNhY2hlLnNldChjYWNoZUtleSwgdGVzdERhdGEpO1xyXG4gICAgICBjb25zdCByZXRyaWV2ZWQgPSBhd2FpdCBhcGlDYWNoZS5nZXQoY2FjaGVLZXkpO1xyXG5cclxuICAgICAgZXhwZWN0KHJldHJpZXZlZCkudG9FcXVhbCh0ZXN0RGF0YSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHJldHVybiBudWxsIGZvciBub24tZXhpc3RlbnQga2V5cycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgcmV0cmlldmVkID0gYXdhaXQgYXBpQ2FjaGUuZ2V0KCdub24tZXhpc3RlbnQta2V5Jyk7XHJcbiAgICAgIGV4cGVjdChyZXRyaWV2ZWQpLnRvQmVOdWxsKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBjYWNoZSBleHBpcmF0aW9uJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCB0ZXN0RGF0YSA9IHsgbWVzc2FnZTogJ0V4cGlyZXMgcXVpY2tseScgfTtcclxuICAgICAgY29uc3QgY2FjaGVLZXkgPSAnZXhwaXJpbmcta2V5JztcclxuXHJcbiAgICAgIC8vIFNldCB3aXRoIHZlcnkgc2hvcnQgVFRMICgxbXMpXHJcbiAgICAgIGF3YWl0IGFwaUNhY2hlLnNldChjYWNoZUtleSwgdGVzdERhdGEsIHsgdHRsOiAxIH0pO1xyXG5cclxuICAgICAgLy8gV2FpdCBmb3IgZXhwaXJhdGlvblxyXG4gICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMikpO1xyXG5cclxuICAgICAgY29uc3QgcmV0cmlldmVkID0gYXdhaXQgYXBpQ2FjaGUuZ2V0KGNhY2hlS2V5KTtcclxuICAgICAgZXhwZWN0KHJldHJpZXZlZCkudG9CZU51bGwoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgY2xlYXIgYWxsIGNhY2hlIGVudHJpZXMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGF3YWl0IGFwaUNhY2hlLnNldCgna2V5MScsICd2YWx1ZTEnKTtcclxuICAgICAgYXdhaXQgYXBpQ2FjaGUuc2V0KCdrZXkyJywgJ3ZhbHVlMicpO1xyXG5cclxuICAgICAgYXBpQ2FjaGUuY2xlYXIoKTtcclxuXHJcbiAgICAgIGV4cGVjdChhd2FpdCBhcGlDYWNoZS5nZXQoJ2tleTEnKSkudG9CZU51bGwoKTtcclxuICAgICAgZXhwZWN0KGF3YWl0IGFwaUNhY2hlLmdldCgna2V5MicpKS50b0JlTnVsbCgpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdMUlUgRXZpY3Rpb24nLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIGV2aWN0IGxlYXN0IHJlY2VudGx5IHVzZWQgaXRlbXMgd2hlbiBjYXBhY2l0eSBpcyBleGNlZWRlZCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgLy8gU2V0IGEgc21hbGwgY2FwYWNpdHkgZm9yIHRlc3RpbmdcclxuICAgICAgY29uc3Qgb3JpZ2luYWxDYXBhY2l0eSA9IChhcGlDYWNoZSBhcyBhbnkpLmNhcGFjaXR5O1xyXG4gICAgICAoYXBpQ2FjaGUgYXMgYW55KS5jYXBhY2l0eSA9IDM7XHJcblxyXG4gICAgICBhd2FpdCBhcGlDYWNoZS5zZXQoJ2tleTEnLCAndmFsdWUxJyk7XHJcbiAgICAgIGF3YWl0IGFwaUNhY2hlLnNldCgna2V5MicsICd2YWx1ZTInKTtcclxuICAgICAgYXdhaXQgYXBpQ2FjaGUuc2V0KCdrZXkzJywgJ3ZhbHVlMycpO1xyXG4gICAgICBhd2FpdCBhcGlDYWNoZS5zZXQoJ2tleTQnLCAndmFsdWU0Jyk7IC8vIFRoaXMgc2hvdWxkIGV2aWN0IGtleTFcclxuXHJcbiAgICAgIGV4cGVjdChhd2FpdCBhcGlDYWNoZS5nZXQoJ2tleTEnKSkudG9CZU51bGwoKTtcclxuICAgICAgZXhwZWN0KGF3YWl0IGFwaUNhY2hlLmdldCgna2V5MicpKS50b0VxdWFsKCd2YWx1ZTInKTtcclxuICAgICAgZXhwZWN0KGF3YWl0IGFwaUNhY2hlLmdldCgna2V5MycpKS50b0VxdWFsKCd2YWx1ZTMnKTtcclxuICAgICAgZXhwZWN0KGF3YWl0IGFwaUNhY2hlLmdldCgna2V5NCcpKS50b0VxdWFsKCd2YWx1ZTQnKTtcclxuXHJcbiAgICAgIC8vIFJlc3RvcmUgb3JpZ2luYWwgY2FwYWNpdHlcclxuICAgICAgKGFwaUNhY2hlIGFzIGFueSkuY2FwYWNpdHkgPSBvcmlnaW5hbENhcGFjaXR5O1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCB1cGRhdGUgTFJVIG9yZGVyIG9uIGFjY2VzcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3Qgb3JpZ2luYWxDYXBhY2l0eSA9IChhcGlDYWNoZSBhcyBhbnkpLmNhcGFjaXR5O1xyXG4gICAgICAoYXBpQ2FjaGUgYXMgYW55KS5jYXBhY2l0eSA9IDM7XHJcblxyXG4gICAgICBhd2FpdCBhcGlDYWNoZS5zZXQoJ2tleTEnLCAndmFsdWUxJyk7XHJcbiAgICAgIGF3YWl0IGFwaUNhY2hlLnNldCgna2V5MicsICd2YWx1ZTInKTtcclxuICAgICAgYXdhaXQgYXBpQ2FjaGUuc2V0KCdrZXkzJywgJ3ZhbHVlMycpO1xyXG5cclxuICAgICAgLy8gQWNjZXNzIGtleTEgdG8gbWFrZSBpdCBtb3N0IHJlY2VudGx5IHVzZWRcclxuICAgICAgYXdhaXQgYXBpQ2FjaGUuZ2V0KCdrZXkxJyk7XHJcblxyXG4gICAgICAvLyBBZGQga2V5NCwgc2hvdWxkIGV2aWN0IGtleTIgKGxlYXN0IHJlY2VudGx5IHVzZWQpXHJcbiAgICAgIGF3YWl0IGFwaUNhY2hlLnNldCgna2V5NCcsICd2YWx1ZTQnKTtcclxuXHJcbiAgICAgIGV4cGVjdChhd2FpdCBhcGlDYWNoZS5nZXQoJ2tleTEnKSkudG9FcXVhbCgndmFsdWUxJyk7IC8vIFN0aWxsIHRoZXJlXHJcbiAgICAgIGV4cGVjdChhd2FpdCBhcGlDYWNoZS5nZXQoJ2tleTInKSkudG9CZU51bGwoKTsgLy8gRXZpY3RlZFxyXG4gICAgICBleHBlY3QoYXdhaXQgYXBpQ2FjaGUuZ2V0KCdrZXkzJykpLnRvRXF1YWwoJ3ZhbHVlMycpO1xyXG4gICAgICBleHBlY3QoYXdhaXQgYXBpQ2FjaGUuZ2V0KCdrZXk0JykpLnRvRXF1YWwoJ3ZhbHVlNCcpO1xyXG5cclxuICAgICAgKGFwaUNhY2hlIGFzIGFueSkuY2FwYWNpdHkgPSBvcmlnaW5hbENhcGFjaXR5O1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdDYWNoZSBQZXJzaXN0ZW5jZScsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgcGVyc2lzdCBjYWNoZSB0byBsb2NhbFN0b3JhZ2UnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHRlc3REYXRhID0geyBwZXJzaXN0ZW50OiB0cnVlIH07XHJcblxyXG4gICAgICBhd2FpdCBhcGlDYWNoZS5zZXQoJ3BlcnNpc3RlbnQta2V5JywgdGVzdERhdGEpO1xyXG5cclxuICAgICAgLy8gQ2hlY2sgdGhhdCBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSB3YXMgY2FsbGVkXHJcbiAgICAgIGV4cGVjdChsb2NhbFN0b3JhZ2VNb2NrLnNldEl0ZW0pLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgY29uc3QgY2FsbEFyZ3MgPSBsb2NhbFN0b3JhZ2VNb2NrLnNldEl0ZW0ubW9jay5jYWxscy5maW5kKGNhbGwgPT5cclxuICAgICAgICBjYWxsWzBdID09PSAnYXBpLWNhY2hlLWRhdGEnXHJcbiAgICAgICk7XHJcbiAgICAgIGV4cGVjdChjYWxsQXJncykudG9CZVRydXRoeSgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCBsb2FkIGNhY2hlIGZyb20gbG9jYWxTdG9yYWdlIG9uIGluaXRpYWxpemF0aW9uJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCBtb2NrQ2FjaGVEYXRhID0ge1xyXG4gICAgICAgICdsb2FkZWQta2V5Jzoge1xyXG4gICAgICAgICAgZGF0YTogJ2xvYWRlZC12YWx1ZScsXHJcbiAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXHJcbiAgICAgICAgICB0dGw6IDM2MDAwMDAsXHJcbiAgICAgICAgfSxcclxuICAgICAgfTtcclxuXHJcbiAgICAgIGxvY2FsU3RvcmFnZU1vY2suZ2V0SXRlbS5tb2NrUmV0dXJuVmFsdWUoSlNPTi5zdHJpbmdpZnkobW9ja0NhY2hlRGF0YSkpO1xyXG5cclxuICAgICAgLy8gQ3JlYXRlIG5ldyBjYWNoZSBpbnN0YW5jZSB0byB0ZXN0IGxvYWRpbmdcclxuICAgICAgY29uc3QgbmV3Q2FjaGUgPSByZXF1aXJlKCcuLi8uLi9saWIvYXBpQ2FjaGUnKS5hcGlDYWNoZTtcclxuXHJcbiAgICAgIC8vIFRoZSBjYWNoZSBzaG91bGQgaGF2ZSBsb2FkZWQgdGhlIGRhdGFcclxuICAgICAgZXhwZWN0KGxvY2FsU3RvcmFnZU1vY2suZ2V0SXRlbSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ2FwaS1jYWNoZS1kYXRhJyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0NhY2hlIFN0YXRpc3RpY3MnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIHRyYWNrIGNhY2hlIGhpdHMgYW5kIG1pc3NlcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgYXdhaXQgYXBpQ2FjaGUuc2V0KCdzdGF0cy1rZXknLCAnc3RhdHMtdmFsdWUnKTtcclxuXHJcbiAgICAgIC8vIEhpdFxyXG4gICAgICBhd2FpdCBhcGlDYWNoZS5nZXQoJ3N0YXRzLWtleScpO1xyXG4gICAgICAvLyBNaXNzXHJcbiAgICAgIGF3YWl0IGFwaUNhY2hlLmdldCgnbm9uLWV4aXN0ZW50LWtleScpO1xyXG5cclxuICAgICAgY29uc3Qgc3RhdHMgPSBhcGlDYWNoZS5nZXRTdGF0cygpO1xyXG4gICAgICBleHBlY3Qoc3RhdHMuaGl0cykudG9CZSgxKTtcclxuICAgICAgZXhwZWN0KHN0YXRzLm1pc3NlcykudG9CZSgxKTtcclxuICAgICAgZXhwZWN0KGFwaUNhY2hlLmdldEhpdFJhdGUoKSkudG9CZSgwLjUpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCB0cmFjayBjYWNoZSBzaXplIGFuZCBjYXBhY2l0eScsIGFzeW5jICgpID0+IHtcclxuICAgICAgYXdhaXQgYXBpQ2FjaGUuc2V0KCdzaXplLWtleTEnLCAndmFsdWUxJyk7XHJcbiAgICAgIGF3YWl0IGFwaUNhY2hlLnNldCgnc2l6ZS1rZXkyJywgJ3ZhbHVlMicpO1xyXG5cclxuICAgICAgY29uc3Qgc3RhdHMgPSBhcGlDYWNoZS5nZXRTdGF0cygpO1xyXG4gICAgICBleHBlY3Qoc3RhdHMuc2l6ZSkudG9CZUdyZWF0ZXJUaGFuKDApO1xyXG4gICAgICBleHBlY3Qoc3RhdHMuaXRlbUNvdW50KS50b0JlKDIpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdSZXF1ZXN0IERlZHVwbGljYXRpb24nLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIGRlZHVwbGljYXRlIGNvbmN1cnJlbnQgcmVxdWVzdHMgZm9yIHRoZSBzYW1lIGtleScsIGFzeW5jICgpID0+IHtcclxuICAgICAgbGV0IGNhbGxDb3VudCA9IDA7XHJcbiAgICAgIGNvbnN0IG1vY2tGZXRjaGVyID0gamVzdC5mbigoKSA9PiB7XHJcbiAgICAgICAgY2FsbENvdW50Kys7XHJcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgnZmV0Y2hlZC1kYXRhJyk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgLy8gU2ltdWxhdGUgY29uY3VycmVudCByZXF1ZXN0c1xyXG4gICAgICBjb25zdCBwcm9taXNlcyA9IFtcclxuICAgICAgICBhcGlDYWNoZS5kZWR1cGUoJ2RlZHVwZS1rZXknLCBtb2NrRmV0Y2hlciksXHJcbiAgICAgICAgYXBpQ2FjaGUuZGVkdXBlKCdkZWR1cGUta2V5JywgbW9ja0ZldGNoZXIpLFxyXG4gICAgICAgIGFwaUNhY2hlLmRlZHVwZSgnZGVkdXBlLWtleScsIG1vY2tGZXRjaGVyKSxcclxuICAgICAgXTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcyk7XHJcblxyXG4gICAgICAvLyBBbGwgc2hvdWxkIHJldHVybiB0aGUgc2FtZSBkYXRhXHJcbiAgICAgIHJlc3VsdHMuZm9yRWFjaCgocmVzdWx0OiBhbnkpID0+IHtcclxuICAgICAgICBleHBlY3QocmVzdWx0KS50b0JlKCdmZXRjaGVkLWRhdGEnKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICAvLyBCdXQgZmV0Y2hlciBzaG91bGQgb25seSBiZSBjYWxsZWQgb25jZVxyXG4gICAgICBleHBlY3QoY2FsbENvdW50KS50b0JlKDEpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgZmV0Y2ggZXJyb3JzIGdyYWNlZnVsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IG1vY2tGZXRjaGVyID0gamVzdC5mbigoKSA9PiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ0ZldGNoIGZhaWxlZCcpKSk7XHJcblxyXG4gICAgICBhd2FpdCBleHBlY3QoXHJcbiAgICAgICAgYXBpQ2FjaGUuZGVkdXBlKCdlcnJvci1rZXknLCBtb2NrRmV0Y2hlcilcclxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coJ0ZldGNoIGZhaWxlZCcpO1xyXG5cclxuICAgICAgLy8gU2hvdWxkIG5vdCBjYWNoZSB0aGUgZXJyb3JcclxuICAgICAgZXhwZWN0KGF3YWl0IGFwaUNhY2hlLmdldCgnZXJyb3Ita2V5JykpLnRvQmVOdWxsKCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ1RhZy1iYXNlZCBJbnZhbGlkYXRpb24nLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIGludmFsaWRhdGUgZW50cmllcyBieSB0YWcnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGF3YWl0IGFwaUNhY2hlLnNldCgndGFnZ2VkLWtleTEnLCAndmFsdWUxJywgeyB0YWdzOiBbJ3RhZzEnXSB9KTtcclxuICAgICAgYXdhaXQgYXBpQ2FjaGUuc2V0KCd0YWdnZWQta2V5MicsICd2YWx1ZTInLCB7IHRhZ3M6IFsndGFnMScsICd0YWcyJ10gfSk7XHJcbiAgICAgIGF3YWl0IGFwaUNhY2hlLnNldCgndW50YWdnZWQta2V5JywgJ3ZhbHVlMycpO1xyXG5cclxuICAgICAgYXBpQ2FjaGUuY2xlYXJCeVRhZ3MoWyd0YWcxJ10pO1xyXG5cclxuICAgICAgZXhwZWN0KGF3YWl0IGFwaUNhY2hlLmdldCgndGFnZ2VkLWtleTEnKSkudG9CZU51bGwoKTtcclxuICAgICAgZXhwZWN0KGF3YWl0IGFwaUNhY2hlLmdldCgndGFnZ2VkLWtleTInKSkudG9CZU51bGwoKTtcclxuICAgICAgZXhwZWN0KGF3YWl0IGFwaUNhY2hlLmdldCgndW50YWdnZWQta2V5JykpLnRvRXF1YWwoJ3ZhbHVlMycpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgbXVsdGlwbGUgdGFncyBjb3JyZWN0bHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGF3YWl0IGFwaUNhY2hlLnNldCgnbXVsdGkta2V5JywgJ3ZhbHVlJywgeyB0YWdzOiBbJ3RhZzEnLCAndGFnMicsICd0YWczJ10gfSk7XHJcblxyXG4gICAgICBhcGlDYWNoZS5jbGVhckJ5VGFncyhbJ3RhZzInXSk7XHJcblxyXG4gICAgICBleHBlY3QoYXdhaXQgYXBpQ2FjaGUuZ2V0KCdtdWx0aS1rZXknKSkudG9CZU51bGwoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnUGVyZm9ybWFuY2UgYW5kIE1lbW9yeSBNYW5hZ2VtZW50JywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgbGFyZ2UgZGF0YXNldHMgZWZmaWNpZW50bHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGxhcmdlRGF0YSA9IEFycmF5LmZyb20oeyBsZW5ndGg6IDEwMDAgfSwgKF8sIGkpID0+ICh7XHJcbiAgICAgICAgaWQ6IGksXHJcbiAgICAgICAgZGF0YTogJ3gnLnJlcGVhdCgxMDAwKSwgLy8gMUtCIHBlciBpdGVtXHJcbiAgICAgIH0pKTtcclxuXHJcbiAgICAgIGNvbnN0IHN0YXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG5cclxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsYXJnZURhdGEubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBhd2FpdCBhcGlDYWNoZS5zZXQoYGxhcmdlLWtleS0ke2l9YCwgbGFyZ2VEYXRhW2ldKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgZW5kVGltZSA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG4gICAgICBjb25zdCBkdXJhdGlvbiA9IGVuZFRpbWUgLSBzdGFydFRpbWU7XHJcblxyXG4gICAgICAvLyBTaG91bGQgY29tcGxldGUgd2l0aGluIHJlYXNvbmFibGUgdGltZSAoYWRqdXN0IHRocmVzaG9sZCBhcyBuZWVkZWQpXHJcbiAgICAgIGV4cGVjdChkdXJhdGlvbikudG9CZUxlc3NUaGFuKDUwMDApOyAvLyA1IHNlY29uZHMgbWF4XHJcblxyXG4gICAgICAvLyBTaG91bGQgYmUgYWJsZSB0byByZXRyaWV2ZSBpdGVtc1xyXG4gICAgICBjb25zdCByZXRyaWV2ZWQgPSBhd2FpdCBhcGlDYWNoZS5nZXQoJ2xhcmdlLWtleS01MDAnKTtcclxuICAgICAgZXhwZWN0KHJldHJpZXZlZCkudG9FcXVhbChsYXJnZURhdGFbNTAwXSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIG1haW50YWluIHBlcmZvcm1hbmNlIHVuZGVyIGNvbmN1cnJlbnQgbG9hZCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgY29uY3VycmVudE9wZXJhdGlvbnMgPSAxMDA7XHJcbiAgICAgIGNvbnN0IHByb21pc2VzID0gW107XHJcblxyXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvbmN1cnJlbnRPcGVyYXRpb25zOyBpKyspIHtcclxuICAgICAgICBwcm9taXNlcy5wdXNoKGFwaUNhY2hlLnNldChgY29uY3VycmVudC1rZXktJHtpfWAsIGB2YWx1ZS0ke2l9YCkpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCBzdGFydFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKTtcclxuICAgICAgYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xyXG4gICAgICBjb25zdCBlbmRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcblxyXG4gICAgICBleHBlY3QoZW5kVGltZSAtIHN0YXJ0VGltZSkudG9CZUxlc3NUaGFuKDIwMDApOyAvLyAyIHNlY29uZHMgbWF4XHJcblxyXG4gICAgICAvLyBWZXJpZnkgYWxsIG9wZXJhdGlvbnMgY29tcGxldGVkXHJcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY29uY3VycmVudE9wZXJhdGlvbnM7IGkrKykge1xyXG4gICAgICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgYXBpQ2FjaGUuZ2V0KGBjb25jdXJyZW50LWtleS0ke2l9YCk7XHJcbiAgICAgICAgZXhwZWN0KHZhbHVlKS50b0JlKGB2YWx1ZS0ke2l9YCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH0pO1xyXG59KTtcclxuIl0sInZlcnNpb24iOjN9